#!/bin/bash
#SBATCH --job-name=Strong_Hybrid_THIN
#SBATCH --partition=THIN
#SBATCH --nodes=4                 # Max 2 nodes â†’ 4 sockets
#SBATCH --ntasks=4                # Max 4 MPI tasks (1 per socket)
#SBATCH --ntasks-per-node=2       # THIN = 2 sockets/node
#SBATCH --cpus-per-task=12        # 12 cores per socket
#SBATCH --exclusive
#SBATCH --time=02:00:00

module load openMPI/5.0.5

OUT_DIR="/u/dssc/msmaddi/HPC/Exe1/Strong_scalability/THIN"
mkdir -p "$OUT_DIR"
CSV_FILE="$OUT_DIR/strong_hybrid_thin.csv"

K=10000
GRID="init_strong.pgm"

# Initialize playground once
mpirun -np 1 --map-by socket ./gameoflife -i -k $K -f $GRID

# Initialize CSV
echo "k,nsteps,mpi_procs,omp_threads,evolution,time" > "$CSV_FILE"
ln -sf "$CSV_FILE" results.csv

# Hybrid strong scaling sweep
for NPROCS in 1 2 4; do
    for THREADS in $(seq 1 12); do
        echo "ðŸ”¹ THIN: MPI=$NPROCS, OMP=$THREADS"
        export OMP_NUM_THREADS=$THREADS
        mpirun -np $NPROCS --map-by socket ./gameoflife -r -f $GRID -k $K -n 100 -e 1 -s 0
    done
done

rm -f results.csv
echo "âœ… Hybrid strong scaling complete: $CSV_FILE"
